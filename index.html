<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QR Code Enhancer - Fixed Version</title>
<style>
  body {
    font-family: Inter, "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, #2D1B4E 0%, #1A0E2E 100%);
    color: #fff;
    min-height: 100vh;
    margin: 0;
    padding: 20px;
  }
  .preview-card {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    padding: 16px;
    min-width: 250px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }
  .qr-container img,
  .qr-container canvas,
  .qr-container svg {
    width: 220px !important;
    height: 220px !important;
    max-width: 220px;
    max-height: 220px;
    display: block;
    margin: auto;
  }
  .glass-container {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    padding: 24px;
    margin-bottom: 16px;
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 18px;
  }
  @media (max-width: 1200px) {
    .glass-container {
      grid-template-columns: 1fr;
    }
  }
  .download-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .download-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .download-btn:hover {
    background: rgba(139, 92, 246, 0.3);
    transform: translateY(-1px);
  }
  #zipFormat {
    padding: 8px 12px;
    margin-right: 8px;
    border-radius: 6px;
    border: none;
    font-size: 1rem;
  }
  #downloadZipBtn {
    background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
    color: white;
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
</head>
<body>

<!-- Global Settings, Code Label Customization, Caption Customization -->
<div class="glass-container">
  <div>
    <h3>Global Settings</h3>
    <label for="globalCaption">Global Caption</label>
    <input type="text" id="globalCaption" placeholder="Enter caption for all QR codes" />
    <br /><br />
    <label for="qrSize">QR Code Size (px)</label>
    <select id="qrSize">
      <option value="220">220px</option>
      <option value="300">300px</option>
      <option value="400">400px</option>
      <!-- Add more if needed -->
    </select>
  </div>
  <div>
    <h3>Code Label Customization</h3>
    <!-- Keep toggles bold/italic as is, no UI effect change -->
    <label>
      <input type="checkbox" id="codeBold" /> Bold
    </label>
    <label>
      <input type="checkbox" id="codeItalic" /> Italic
    </label>
  </div>
  <div>
    <h3>Caption Customization</h3>
    <!-- Same toggles and style -->
    <label>
      <input type="checkbox" id="captionBold" /> Bold
    </label>
    <label>
      <input type="checkbox" id="captionItalic" /> Italic
    </label>
  </div>
</div>

<!-- QR Upload Section -->
<input type="file" id="fileInput" multiple accept="image/png, image/jpeg, image/svg+xml" />
<button onclick="handleFileUpload()">Upload QR Codes</button>

<!-- Preview Sections -->
<div style="margin-top: 24px;">
  <h3>Input QR Codes Original</h3>
  <div id="inputPreview" style="display: flex; gap: 16px; overflow-x: auto;"></div>
</div>
<div style="margin-top: 24px;">
  <h3>Enhanced QR Codes Output</h3>
  <div id="outputPreview" style="display: flex; gap: 16px; overflow-x: auto;"></div>
</div>

<!-- Zip Download Option -->
<div style="margin-top: 24px;">
  <select id="zipFormat">
    <option value="png">PNG (ZIP)</option>
    <option value="jpg">JPG (ZIP)</option>
    <option value="svg">SVG (ZIP)</option>
  </select>
  <button id="downloadZipBtn" onclick="downloadAllZip()">Download All as ZIP</button>
</div>

<script>
  let qrData = [];

  function getQRSize() {
    const size = document.getElementById('qrSize').value;
    return parseInt(size) || 220;
  }

  // Dummy readImageFile and decodeQRCode for example, replace with real code
  async function readImageFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function decodeQRCode(imageData) {
    // Use your existing QR decoding logic here
    // For demonstration, returning dummy data:
    return `CODE-${Math.floor(Math.random() * 10000)}`;
  }

  async function handleFileUpload() {
    const input = document.getElementById('fileInput');
    if (!input.files.length) {
      alert('Please select files to upload.');
      return;
    }
    qrData = [];
    for (const file of input.files) {
      try {
        const imageData = await readImageFile(file);
        const code = await decodeQRCode(imageData);
        qrData.push({
          originalImage: imageData,
          extractedText: code,
          code: code,
          caption: '',
          feNumber: '',
          qrContainer: null,
        });
      } catch (e) {
        console.error('Error decoding QR:', e);
      }
    }
    renderPreviews();
  }

  function renderPreviews() {
    const inputPreview = document.getElementById('inputPreview');
    const outputPreview = document.getElementById('outputPreview');
    inputPreview.innerHTML = '';
    outputPreview.innerHTML = '';

    const qrSize = getQRSize();

    qrData.forEach((item, index) => {
      // Input preview
      const inputCard = document.createElement('div');
      inputCard.className = 'preview-card';
      const inputImg = document.createElement('img');
      inputImg.src = item.originalImage;
      inputImg.style.width = '220px';
      inputImg.style.height = '220px';
      inputCard.appendChild(inputImg);
      inputPreview.appendChild(inputCard);

      // Output preview (generate simple QR SVG or canvas - here dummy placeholder)
      const outputCard = document.createElement('div');
      outputCard.className = 'preview-card';
      outputCard.id = 'output-index-' + index;
      
      const qrContainer = document.createElement('div');
      qrContainer.className = 'qr-container';

      // Create dummy canvas for output QR with white bg for downloads
      const canvas = document.createElement('canvas');
      canvas.width = qrSize;
      canvas.height = qrSize;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#fff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#000';
      ctx.font = '30px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(item.extractedText, qrSize / 2, qrSize / 2);
      qrContainer.appendChild(canvas);

      outputCard.appendChild(qrContainer);

      // Download buttons for PNG, JPG, SVG
      const downloadButtons = document.createElement('div');
      downloadButtons.className = 'download-buttons';

      ['png', 'jpg', 'svg'].forEach((format) => {
        const btn = document.createElement('button');
        btn.className = 'download-btn';
        btn.textContent = format.toUpperCase();
        btn.onclick = () => downloadQR(index, format);
        downloadButtons.appendChild(btn);
      });

      outputCard.appendChild(downloadButtons);

      outputPreview.appendChild(outputCard);

      // Store qrContainer for downloads etc.
      item.qrContainer = qrContainer;
    });
  }

  function downloadFile(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function downloadQR(index, format) {
    const item = qrData[index];
    if (!item.qrContainer) return;
    const qrSize = getQRSize();

    if (format === 'svg') {
      const svgElem = item.qrContainer.querySelector('svg');
      if (svgElem) {
        let serializer = new XMLSerializer();
        let svgString = serializer.serializeToString(svgElem);
        // Wrapper for background
        svgString = `<svg xmlns="http://www.w3.org/2000/svg" width="${qrSize}" height="${qrSize}" viewBox="0 0 ${qrSize} ${qrSize}">
          <rect width="100%" height="100%" fill="white" />
          ${svgString}
        </svg>`;
        const blob = new Blob([svgString], { type: 'image/svg+xml' });
        downloadFile(blob, `${item.code}.${format}`);
      } else {
        alert('SVG not available');
      }
    } else {
      // PNG or JPG download from canvas
      const canvas = item.qrContainer.querySelector('canvas');
      if (!canvas) {
        alert('Canvas not found');
        return;
      }
      const mimeType = format === 'jpg' ? 'image/jpeg' : 'image/png';
      canvas.toBlob((blob) => {
        if (blob) downloadFile(blob, `${item.code}.${format}`);
        else alert('Failed to create file');
      }, mimeType, format === 'jpg' ? 0.95 : undefined);
    }
  }

  async function generateQRBlob(item, format) {
    // For ZIP download of all, similar to downloadQR but returns Blob instead of downloading.
    const qrSize = getQRSize();
    if (format === 'svg') {
      const svgElem = item.qrContainer.querySelector('svg');
      if (!svgElem) return null;
      let serializer = new XMLSerializer();
      let svgString = serializer.serializeToString(svgElem);
      svgString = `<svg xmlns="http://www.w3.org/2000/svg" width="${qrSize}" height="${qrSize}" viewBox="0 0 ${qrSize} ${qrSize}">
        <rect width="100%" height="100%" fill="white" />
        ${svgString}
      </svg>`;
      return new Blob([svgString], { type: 'image/svg+xml' });
    } else {
      const canvas = item.qrContainer.querySelector('canvas');
      if (!canvas) return null;
      return new Promise(resolve => {
        canvas.toBlob(blob => resolve(blob), (format === 'jpg' ? 'image/jpeg' : 'image/png'), (format === 'jpg' ? 0.95 : undefined));
      });
    }
  }

  async function downloadAllZip() {
    if (qrData.length === 0) {
      alert('No QR codes available to download.');
      return;
    }
    const format = document.getElementById('zipFormat').value;
    const zip = new JSZip();
    for (let i = 0; i < qrData.length; i++) {
      const blob = await generateQRBlob(qrData[i], format);
      if (blob) {
        zip.file(`QR_${qrData[i].code}.${format}`, blob);
      }
    }
    zip.generateAsync({ type: 'blob' }).then((content) => {
      downloadFile(content, `QRCodes_${format}_${Date.now()}.zip`);
    });
  }
</script>

</body>
</html>
